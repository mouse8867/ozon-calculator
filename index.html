<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <!-- 修改：更新 Content-Security-Policy 以允许 freecurrencyapi.com 的连接 -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org; connect-src 'self' https://api.freecurrencyapi.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OZON选品计算器----开放版 v2.5.1</title> <!-- 版本号已更新 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c3e50',
                        secondary: '#3498db',
                        accent: '#4CAF50',
                        warning: '#e74c3c',
                        neutral: '#f0f0f0',
                        'neutral-dark': '#2c3e50',
                    },
                    fontFamily: {
                        sans: ['DengXian', 'Microsoft YaHei', 'sans-serif'],
                    },
                    boxShadow: {
                        'custom': '0 15px 40px rgba(0, 0, 0, 0.3)',
                        'card': '0 5px 15px rgba(0, 0, 0, 0.1)',
                    }
                },
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .input-focus {
                @apply focus:border-secondary focus:ring-2 focus:ring-secondary/20 outline-none;
            }
            .btn-effect {
                @apply transition-all duration-300 hover:shadow-lg active:scale-95;
            }
            .section-bg-a {
                @apply bg-red-50/70;
            }
            .section-bg-b {
                @apply bg-blue-50/70;
            }
            .section-bg-c {
                @apply bg-red-50/70;
            }
            .section-bg-d {
                @apply bg-gray-50/70;
            }
            .section-bg-e {
                @apply bg-blue-50/90;
            }
            .section-bg-f {
                @apply bg-red-50/70;
            }
            .result-bg-1 {
                @apply bg-[#d2b48c];
            }
            .result-bg-2 {
                @apply bg-gray-200;
            }
            .input-group {
                @apply flex items-center h-8;
            }
            .input-label {
                @apply w-48 text-base text-gray-700 font-normal whitespace-nowrap overflow-hidden text-ellipsis; 
            }
            .input-field {
                @apply w-32 px-2 py-1 border border-gray-300 rounded input-focus text-right text-base font-medium; 
            }
            .result-label {
                @apply w-48 text-base text-gray-600 font-normal; 
            }
            .result-highlight-label-text {
                @apply text-base font-bold;
            }
            .result-value {
                @apply w-48 px-2 py-1 rounded text-base font-bold flex items-center justify-end;
            }
            .large-result-value-number {
                @apply text-xl font-bold w-40 text-right;
            }
            input[type="number"]::-webkit-outer-spin-button,
            input[type="number"]::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            input[type="number"] {
                -moz-appearance: textfield;
            }
            .unit-symbol {
                @apply text-base text-gray-600 ml-2 font-bold; 
            }
            .result-highlight-unit-symbol {
                @apply text-xl text-gray-600 ml-1 font-bold;
            }
            .exchange-spinner {
                display: inline-block;
                width: 12px;
                height: 12px;
                border: 2px solid rgba(255,255,255,0.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-primary to-neutral-dark min-h-screen flex items-center justify-center p-3">
    <div class="calculator-container w-full max-w-5xl bg-white rounded-xl shadow-custom overflow-hidden grid grid-cols-1">
        <!-- 标题区域 -->
        <div class="title-container bg-gradient-to-r from-primary to-secondary text-white p-4 md:col-span-2">
            <div class="flex justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold"><i class="fa fa-calculator mr-2"></i>OZON选品计算器----开放版</h1>
                <div class="version cursor-pointer hover:underline" title="点击查看更新日志">v2.5.1</div> <!-- 版本号已更新 -->
            </div>
        </div>
        
        <!-- 计算区域 -->
        <div class="grid grid-cols-1 md:grid-cols-2">
            <!-- 左侧区域 - ABCDF -->
            <div class="left-section md:col-span-1 flex flex-col">
                <!-- A区 -->
                <div class="section section-bg-a p-3 border-b border-r border-gray-200">
                    <div class="section-title flex items-center mb-2">
                        <span class="text-xs mr-2">■</span>
                        <span class="text-sm font-bold text-primary">商品基础信息</span>
                    </div>
                    <div class="space-y-1.5">
                        <div class="input-group">
                            <label for="C2" class="input-label">预售价格:</label>
                            <input type="number" id="C2" value="600" class="input-field">
                            <span class="unit-symbol">₽</span>
                        </div>
                        <div class="input-group">
                            <label for="C3" class="input-label">商品进价(含运费):</label>
                            <input type="number" id="C3" value="5.75" class="input-field">
                            <span class="unit-symbol">￥</span>
                        </div>
                        <div class="input-group">
                            <label for="C4" class="input-label">商品重量:</label>
                            <input type="number" id="C4" value="0.2" class="input-field">
                            <span class="unit-symbol">kg</span>
                        </div>
                        <div class="input-group">
                            <label for="C5" class="input-label">后台到账:</label>
                            <input type="number" id="C5" value="330" class="input-field">
                            <span class="unit-symbol">₽</span>
                        </div>
                    </div>
                </div>
                
                <!-- B区 -->
                <div class="section section-bg-b p-3 border-b border-r border-gray-200">
                    <div class="section-title flex items-center mb-2">
                        <span class="text-xs mr-2">■</span>
                        <span class="text-sm font-bold text-primary">财务参数调整</span>
                    </div>
                    <div class="space-y-1.5">
                        <div class="input-group">
                            <label for="C7" class="input-label">银行税率:</label>
                            <input type="number" id="C7" class="cautious input-field" value="7">
                            <span class="unit-symbol">%</span>
                        </div>
                        <div class="input-group">
                            <label for="C8" class="input-label">提现手续费:</label>
                            <input type="number" id="C8" class="cautious input-field" value="10">
                            <span class="unit-symbol">%</span>
                        </div>
                        <div class="input-group">
                            <label for="C9" class="input-label">退货汇损:</label>
                            <input type="number" id="C9" class="cautious input-field" value="6">
                            <span class="unit-symbol">%</span>
                        </div>
                    </div>
                </div>
                
                <!-- C区 - 汇率信息 -->
                <div class="section section-bg-c p-3 border-b border-r border-gray-200">
                    <div class="section-title flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <span class="text-xs mr-2">■</span>
                            <span class="text-sm font-bold text-primary">汇率信息</span>
                        </div>
                        <button id="refreshExchange" class="text-xs bg-secondary text-white px-2 py-1 rounded btn-effect flex items-center">
                            <i class="fa fa-refresh mr-1" id="refreshIcon"></i>更新汇率
                        </button>
                    </div>
                    <div class="space-y-1.5">
                        <div class="input-group">
                            <label for="C11" class="input-label">卢布汇率:</label>
                            <input type="number" id="C11" value="11.7" class="input-field">
                            <div class="ml-2 flex items-center">
                                <span id="rubStatus" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">加载中...</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="C12" class="input-label">美元汇率:</label>
                            <input type="number" id="C12" value="7.2" class="input-field">
                            <div class="ml-2 flex items-center">
                                <span id="usdStatus" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- D区 -->
                <div class="section section-bg-d p-3 border-b border-r border-gray-200">
                    <div class="section-title flex items-center mb-2">
                        <span class="text-xs mr-2">■</span>
                        <span class="text-sm font-bold text-primary">物流成本基数</span>
                    </div>
                    <div class="space-y-1.5">
                        <div class="input-group">
                            <label for="C14" class="input-label">物流基数:</label>
                            <input type="number" id="C14" class="cautious input-field" value="2.5">
                            <span class="unit-symbol">$</span>
                        </div>
                    </div>
                </div>
                
                <!-- F区 -->
                <div class="section section-bg-f p-3 border-r border-gray-200">
                    <div class="section-title flex items-center mb-2">
                        <span class="text-xs mr-2">■</span>
                        <span class="text-sm font-bold text-primary">包裹尺寸与数量</span>
                    </div>
                    <div class="space-y-1.5">
                        <div class="input-group">
                            <label for="D14" class="input-label">本批次总箱数:</label>
                            <input type="number" id="D14" value="15" class="input-field">
                        </div>
                    </div>
                    <div class="space-y-1.5 mt-2">
                        <div class="input-group">
                            <label for="E14" class="input-label">长:</label>
                            <input type="number" id="E14" value="12.00" class="input-field">
                            <span class="unit-symbol">cm</span>
                        </div>
                        <div class="input-group">
                            <label for="F14" class="input-label">宽:</label>
                            <input type="number" id="F14" value="12.00" class="input-field">
                            <span class="unit-symbol">cm</span>
                        </div>
                        <div class="input-group">
                            <label for="G14" class="input-label">高:</label>
                            <input type="number" id="G14" value="28.00" class="input-field">
                            <span class="unit-symbol">cm</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧区域 - GHIE -->
            <div class="right-section md:col-span-1 flex flex-col">
                <!-- G区结果 -->
                <div class="results-section bg-gray-50 p-3 border-b border-gray-200">
                    <div class="result-title bg-gradient-to-r from-accent to-green-700 text-white text-center py-1 rounded text-sm font-bold mb-2">
                        结果计算区
                    </div>
                    <div class="space-y-1.5">
                        <div class="result-item flex items-center h-8">
                            <div class="result-label flex items-center w-48 text-gray-600">
                                <span class="text-xs mr-1 text-secondary">►</span>
                                <span class="result-highlight-label-text">回款金额:</span>
                            </div>
                            <div class="result-value result-bg-1 px-2 py-1 rounded text-right">
                                <span id="H4_value" class="large-result-value-number">0.00</span>
                            </div>
                            <span class="result-highlight-unit-symbol">￥</span>
                        </div>
                        <div class="result-item flex items-center h-8">
                            <div class="result-label flex items-center w-48 text-gray-600">
                                <span class="text-xs mr-1 text-secondary">►</span>
                                <span class="result-highlight-label-text">FBO利润率:</span>
                            </div>
                            <div class="result-value result-bg-1 px-2 py-1 rounded text-right">
                                <span id="H5_value" class="large-result-value-number">0.00</span>
                            </div>
                            <span class="result-highlight-unit-symbol">%</span>
                        </div>
                        <div class="result-item flex items-center justify-center h-12 mt-4"> 
                            <div id="profitStatus" class="text-center text-3xl font-extrabold">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- H区结果 -->
                <div class="results-section bg-gray-50 p-3 border-b border-gray-200">
                    <div class="space-y-1.5">
                        <div class="result-item flex items-center h-8">
                            <div class="result-label flex items-center w-48 text-gray-600">
                                <span class="text-xs mr-1 text-secondary">►</span>
                                <span>中转物流费:</span>
                            </div>
                            <div class="result-value result-bg-2 px-2 py-1 rounded text-right">
                                <span id="H8_value">0.00</span><span class="unit-symbol">￥</span>
                            </div>
                        </div>
                        <div class="result-item flex items-center h-8">
                            <div class="result-label flex items-center w-48 text-gray-600">
                                <span class="text-xs mr-1 text-secondary">►</span>
                                <span>俄罗斯送仓费:</span>
                            </div>
                            <div class="result-value result-bg-2 px-2 py-1 rounded text-right">
                                <span id="H9_value">0.00</span><span class="unit-symbol">￥</span>
                            </div>
                        </div>
                        <div class="result-item flex items-center h-8">
                            <div class="result-label flex items-center w-48 text-gray-600">
                                <span class="text-xs mr-1 text-secondary">►</span>
                                <span>前端总成本:</span>
                            </div>
                            <div class="result-value result-bg-2 px-2 py-1 rounded text-right">
                                <span id="H10_value">0.00</span><span class="unit-symbol">￥</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- I区结果 -->
                <div class="results-section bg-gray-50 p-3 border-b border-gray-200">
                    <div class="result-item flex items-center h-8">
                        <div class="result-label flex items-center w-48 text-gray-600">
                            <span class="text-xs mr-1 text-secondary">►</span>
                            <span>预计装箱数量:</span>
                        </div>
                        <div class="result-value result-bg-1 px-2 py-1 rounded text-right">
                            <span id="H14_value">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- E区 -->
                <div class="section section-bg-e p-3">
                    <div class="section-title flex items-center mb-2">
                        <span class="text-xs mr-2">■</span>
                        <span class="text-sm font-bold text-primary">国内/国外费率</span>
                    </div>
                    
                    <div class="sub-section pt-2 mt-2 border-t border-dashed border-gray-300">
                        <div class="space-y-1.5">
                            <div class="sub-section-title text-xs font-bold text-primary mb-2">国内基础费率</div>
                            <div class="input-group">
                                <label for="F2" class="input-label">空箱重量:</label>
                                <input type="number" id="F2" value="1.5" class="input-field">
                                <span class="unit-symbol">kg</span>
                            </div>
                            <div class="input-group">
                                <label for="F3" class="input-label">贴单+胶带:</label>
                                <input type="number" id="F3" value="0.1" class="input-field">
                                <span class="unit-symbol">￥</span>
                            </div>
                            <div class="input-group">
                                <label for="F4" class="input-label">商品包装:</label>
                                <input type="number" id="F4" value="0.5" class="input-field">
                                <span class="unit-symbol">￥</span>
                            </div>
                            <div class="input-group">
                                <label for="F5" class="input-label">外箱:</label>
                                <input type="number" id="F5" value="6" class="input-field">
                                <span class="unit-symbol">￥</span>
                            </div>
                            <div class="input-group">
                                <label for="F6" class="input-label">防水耗材:</label>
                                <input type="number" id="F6" value="4" class="input-field">
                                <span class="unit-symbol">￥</span>
                            </div>
                            <div class="input-group">
                                <label for="F7" class="input-label">国内中转费:</label>
                                <input type="number" id="F7" value="150" class="input-field">
                                <span class="unit-symbol">￥</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sub-section pt-2 mt-2 border-t border-dashed border-gray-300">
                        <div class="sub-section-title text-xs font-bold text-primary mb-2">国外基础费率</div>
                        <div class="space-y-1.5">
                            <div class="input-group">
                                <label for="F9" class="input-label">搬运费:</label>
                                <input type="number" id="F9" value="1.92" class="input-field">
                                <span class="unit-symbol">$</span>
                            </div>
                            <div class="input-group">
                                <label for="F10" class="input-label">送仓费:</label>
                                <input type="number" id="F10" value="3.5" class="input-field">
                                <span class="unit-symbol">$</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 按钮区域 -->
        <div class="actions bg-gray-100 py-3 px-5 flex justify-center items-center border-t border-gray-300 md:col-span-2">
            <button class="reset-btn bg-gradient-to-r from-warning to-red-700 text-white px-8 py-2 rounded-lg font-bold shadow-md btn-effect">
                <i class="fa fa-refresh mr-2"></i>恢复初始数值
            </button>
        </div>
    </div>
    
    <!-- 提示模态框 -->
    <div class="modal fixed inset-0 bg-black/70 z-50 hidden items-center justify-center">
        <div class="modal-content bg-white p-5 rounded-lg w-80 max-w-md text-center shadow-xl transform transition-all">
            <div class="modal-title text-xl font-bold text-warning mb-4">⚠️ 警告</div>
            <div class="modal-message text-gray-700 mb-6">请谨慎修改此值！修改后可能会影响计算结果准确性。</div>
            <div class="modal-buttons flex justify-center gap-4">
                <button class="modal-btn confirm-btn bg-gradient-to-r from-secondary to-blue-700 text-white px-5 py-2 rounded font-bold btn-effect">
                    确认修改
                </button>
                <button class="modal-btn cancel-btn bg-gradient-to-r from-gray-300 to-gray-500 text-gray-800 px-5 py-2 rounded font-bold btn-effect">
                    取消
                </button>
            </div>
        </div>
    </div>
    
    <!-- 更新日志模态框 -->
    <div class="changelog-modal fixed inset-0 bg-black/70 z-50 hidden items-center justify-center">
        <div class="changelog-content bg-white p-5 rounded-lg w-11/12 max-w-2xl max-h-[80vh] overflow-y-auto shadow-xl transform transition-all">
            <div class="changelog-title text-xl font-bold text-secondary mb-4 text-center">更新日志</div>
            <div class="changelog-list">
                <div class="changelog-version text-lg font-bold text-primary mb-1">v2.5.1</div> <!-- 新增日志 -->
                <div class="changelog-date text-sm text-gray-500 mb-2">2025-07-01</div>
                <div class="changelog-items mb-4 pl-4">
                    <div class="changelog-item text-gray-700 mb-1">集成 Free Currency API 实现汇率自动更新。</div>
                    <div class="changelog-item text-gray-700 mb-1">新增汇率缓存机制，网页加载时优先显示上次API获取的数值。</div>
                    <div class="changelog-item text-gray-700 mb-1">限制汇率API更新频率为每8小时一次（包括自动和手动更新）。</div>
                    <div class="changelog-item text-gray-700 mb-1">更新汇率计算逻辑，确保美元汇率(1美元=?人民币)和卢布汇率(1人民币=?卢布)正确。</div>
                    <div class="changelog-item text-gray-700 mb-1">“更新汇率”按钮动态显示下次更新时间。</div>
                </div>
                <div class="changelog-version text-lg font-bold text-primary mb-1">v2.5.0</div>
                <div class="changelog-date text-sm text-gray-500 mb-2">2025-07-01</div>
                <div class="changelog-items mb-4 pl-4">
                    <div class="changelog-item text-gray-700 mb-1">新增汇率自动获取功能</div>
                    <div class="changelog-item text-gray-700 mb-1">添加汇率更新按钮和状态显示</div>
                    <div class="changelog-item text-gray-700 mb-1">优化汇率区域布局</div>
                </div>
                <div class="changelog-version text-lg font-bold text-primary mb-1">v2.4.9</div>
                <div class="changelog-items mb-4 pl-4">
                    <div class="changelog-item text-gray-700 mb-1">开放版：仅修改标题，参数保持原样。</div>
                </div>
                <!-- 省略其他日志... -->
            </div>
            <button class="close-changelog mt-5 w-full bg-gradient-to-r from-gray-300 to-gray-500 text-gray-800 px-5 py-2 rounded font-bold btn-effect">
                <i class="fa fa-times mr-2"></i>关闭
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 存储初始值 (用于恢复初始数值按钮)
            const initialValues = {
                C2: 600,
                C3: 5.75,
                C4: 0.2,
                C5: 330,
                C7: 7,
                C8: 10,
                C9: 6,
                C11: 11.7, // 默认卢布汇率 (1 CNY = ? RUB)
                C12: 7.2,  // 默认美元汇率 (1 USD = ? CNY)
                C14: 2.5,
                F2: 1.5,
                F3: 0.1,
                F4: 0.5,
                F5: 6,
                F6: 4,
                F7: 150,
                F9: 1.92,
                F10: 3.5,
                D14: 15,
                E14: 12.00,
                F14: 12.00,
                G14: 28.00
            };
            
            // 全局常量和变量
            const API_KEY = 'fca_live_ybeaLB75p7bkwOG0Rey2VWDvAPiNQvCGvMKvzRnZ'; // 您的 Free Currency API Key
            const CACHE_KEY = 'ozonExchangeRatesCache'; // 本地存储的键名
            const CACHE_DURATION = 8 * 60 * 60 * 1000; // 8 小时 (毫秒)
            let lastApiUpdateTime = 0; // 存储上次成功 API 更新的时间戳

            let currentCautiousInput = null;
            const resetBtn = document.querySelector('.reset-btn');
            const modal = document.querySelector('.modal');
            const confirmBtn = document.querySelector('.confirm-btn');
            const cancelBtn = document.querySelector('.cancel-btn');
            const versionElement = document.querySelector('.version');
            const changelogModal = document.querySelector('.changelog-modal');
            const closeChangelog = document.querySelector('.close-changelog');
            const profitStatusElement = document.getElementById('profitStatus');
            const refreshExchangeBtn = document.getElementById('refreshExchange');
            let refreshIcon = document.getElementById('refreshIcon'); // 使用 let 以便在 innerHTML 改变后重新获取
            const rubStatus = document.getElementById('rubStatus');
            const usdStatus = document.getElementById('usdStatus');
            
            // 页面加载时，移除所有数字输入框的步进属性，并初始化其 previousValidValue
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.removeAttribute('step');
                // 初始化所有输入框的 previousValidValue，包括 C11 和 C12，它们将在 loadExchangeRates 中被覆盖
                input.dataset.previousValidValue = initialValues[input.id] !== undefined ? initialValues[input.id].toString() : input.value; 
            });

            // 汇率获取函数：从 API 获取并更新 UI 和缓存
            async function fetchExchangeRatesFromApi() {
                refreshIcon.className = 'fa fa-refresh mr-1 exchange-spinner'; // 显示加载动画
                rubStatus.textContent = '获取中...';
                rubStatus.className = 'text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-700';
                usdStatus.textContent = '获取中...';
                usdStatus.className = 'text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-700';

                try {
                    // API 请求：获取 RUB 和 CNY 相对于 USD 的汇率
                    const response = await fetch(`https://api.freecurrencyapi.com/v1/latest?apikey=${API_KEY}&currencies=RUB,CNY`);
                    const data = await response.json();

                    if (response.ok && data.data && data.data.RUB && data.data.CNY) {
                        const rubPerUsd = data.data.RUB; // 1 USD = X RUB
                        const cnyPerUsd = data.data.CNY; // 1 USD = Y CNY

                        // 计算卢布汇率 (1 CNY = ? RUB)
                        // 1 USD = rubPerUsd RUB
                        // 1 USD = cnyPerUsd CNY
                        // 所以 cnyPerUsd CNY = rubPerUsd RUB
                        // 1 CNY = (rubPerUsd / cnyPerUsd) RUB
                        const rubRate = rubPerUsd / cnyPerUsd; 

                        // 计算美元汇率 (1 USD = ? CNY)
                        const usdRate = cnyPerUsd; 

                        document.getElementById('C11').value = rubRate.toFixed(4);
                        document.getElementById('C11').dataset.previousValidValue = rubRate.toFixed(4);
                        document.getElementById('C12').value = usdRate.toFixed(4);
                        document.getElementById('C12').dataset.previousValidValue = usdRate.toFixed(4);

                        const newTimestamp = Date.now();
                        localStorage.setItem(CACHE_KEY, JSON.stringify({ rub: rubRate, usd: usdRate, timestamp: newTimestamp }));
                        lastApiUpdateTime = newTimestamp; // 更新上次 API 更新时间

                        rubStatus.textContent = '已更新';
                        rubStatus.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-700';
                        usdStatus.textContent = '已更新';
                        usdStatus.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-700';
                        showNotification(`汇率更新成功: 卢布 ${rubRate.toFixed(4)}, 美元 ${usdRate.toFixed(4)}`);
                    } else {
                        // 如果 API 返回失败状态或数据不完整
                        throw new Error(data.message || 'API返回失败状态或数据不完整。');
                    }
                } catch (error) {
                    console.error('汇率获取失败:', error);
                    rubStatus.textContent = '获取失败';
                    rubStatus.className = 'text-xs px-2 py-1 rounded bg-red-100 text-red-700';
                    usdStatus.textContent = '获取失败';
                    usdStatus.className = 'text-xs px-2 py-1 rounded bg-red-100 text-red-700';
                    showNotification('汇率获取失败，请检查API Key或网络。', 'error');
                    
                    // 如果API获取失败，回退到 initialValues
                    document.getElementById('C11').value = initialValues.C11;
                    document.getElementById('C11').dataset.previousValidValue = initialValues.C11.toString();
                    document.getElementById('C12').value = initialValues.C12;
                    document.getElementById('C12').dataset.previousValidValue = initialValues.C12.toString();
                    showNotification('已回退至默认汇率。', 'warning');
                } finally {
                    refreshIcon.className = 'fa fa-refresh mr-1'; // 移除加载动画
                    calculateAll(); // 无论成功失败，都重新计算
                    updateRefreshButtonState(); // 更新按钮状态
                }
            }

            // 加载汇率：优先从缓存加载，否则从 API 获取
            async function loadExchangeRates() {
                const cachedData = JSON.parse(localStorage.getItem(CACHE_KEY));
                const now = Date.now();

                if (cachedData && (now - cachedData.timestamp < CACHE_DURATION)) {
                    // 使用缓存数据
                    document.getElementById('C11').value = cachedData.rub.toFixed(4);
                    document.getElementById('C11').dataset.previousValidValue = cachedData.rub.toFixed(4);
                    document.getElementById('C12').value = cachedData.usd.toFixed(4);
                    document.getElementById('C12').dataset.previousValidValue = cachedData.usd.toFixed(4);

                    rubStatus.textContent = '来自缓存';
                    rubStatus.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-700';
                    usdStatus.textContent = '来自缓存';
                    usdStatus.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-700';

                    lastApiUpdateTime = cachedData.timestamp; // 更新上次 API 更新时间为缓存时间
                    showNotification('汇率已从缓存加载。');
                    calculateAll(); // 加载后计算
                    updateRefreshButtonState(); // 更新按钮状态
                } else {
                    // 缓存无效或过期，从 API 获取
                    await fetchExchangeRatesFromApi();
                }
            }

            // 更新“更新汇率”按钮的状态（禁用/启用，显示剩余时间）
            function updateRefreshButtonState() {
                const now = Date.now();
                const timeUntilNextUpdate = lastApiUpdateTime + CACHE_DURATION - now;

                if (timeUntilNextUpdate <= 0) {
                    refreshExchangeBtn.disabled = false;
                    refreshExchangeBtn.innerHTML = '<i class="fa fa-refresh mr-1" id="refreshIcon"></i>更新汇率';
                    refreshIcon = document.getElementById('refreshIcon'); // 重新获取图标引用
                } else {
                    refreshExchangeBtn.disabled = true;
                    const remainingHours = Math.floor(timeUntilNextUpdate / (1000 * 60 * 60));
                    const remainingMinutes = Math.ceil((timeUntilNextUpdate % (1000 * 60 * 60)) / (1000 * 60));
                    refreshExchangeBtn.innerHTML = `<i class="fa fa-clock-o mr-1"></i>下次更新: ${remainingHours}小时${remainingMinutes}分`;
                    
                    // 设置定时器，在剩余时间结束后重新检查按钮状态
                    setTimeout(updateRefreshButtonState, timeUntilNextUpdate + 1000); // 加1秒缓冲
                }
            }
            
            // 为所有数字输入框添加焦点和失焦事件监听
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('focus', function() {
                    if (this.value !== '') {
                        this.dataset.previousValidValue = this.value; 
                    }
                    this.value = '';
                    // 特殊处理汇率输入框的状态显示
                    if (input.id === 'C11') {
                        rubStatus.textContent = '编辑中...';
                        rubStatus.className = 'text-xs px-2 py-1 rounded bg-blue-100 text-blue-700';
                    } else if (input.id === 'C12') {
                        usdStatus.textContent = '编辑中...';
                        usdStatus.className = 'text-xs px-2 py-1 rounded bg-blue-100 text-blue-700';
                    }
                });
                
                input.addEventListener('blur', function() {
                    const inputElement = this;
                    const inputValue = inputElement.value.trim();
                    const previousValidValue = inputElement.dataset.previousValidValue;

                    const parsedValue = parseFloat(inputValue);
                    const isEffectivelyANumber = inputValue !== '' && !isNaN(parsedValue); 

                    if (inputElement.classList.contains('cautious')) {
                        if (isEffectivelyANumber && parsedValue !== parseFloat(previousValidValue)) {
                            currentCautiousInput = inputElement;
                            inputElement.dataset.tempNewValue = parsedValue;
                            modal.style.display = 'flex';
                        } else {
                            inputElement.value = previousValidValue;
                            calculateAll();
                        }
                    } else {
                        if (isEffectivelyANumber) {
                            inputElement.value = parsedValue;
                            inputElement.dataset.previousValidValue = parsedValue;
                        } else {
                            inputElement.value = previousValidValue;
                        }
                        calculateAll();
                    }

                    // 特殊处理汇率输入框的状态显示
                    if (input.id === 'C11') {
                        rubStatus.textContent = '已修改';
                        rubStatus.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-700';
                    } else if (input.id === 'C12') {
                        usdStatus.textContent = '已修改';
                        usdStatus.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-700';
                    }
                });
            });
            
            // 版本号点击事件
            if (versionElement) {
                versionElement.addEventListener('click', function() {
                    changelogModal.style.display = 'flex';
                });
            }
            
            // 关闭更新日志
            closeChangelog.addEventListener('click', function() {
                changelogModal.style.display = 'none';
            });
            
            // 模态框确认按钮事件
            confirmBtn.addEventListener('click', function() {
                if (currentCautiousInput) {
                    currentCautiousInput.value = currentCautiousInput.dataset.tempNewValue;
                    currentCautiousInput.dataset.previousValidValue = currentCautiousInput.dataset.tempNewValue;
                }
                modal.style.display = 'none';
                calculateAll();
            });
            
            // 模态框取消按钮事件
            cancelBtn.addEventListener('click', function() {
                if (currentCautiousInput) {
                    currentCautiousInput.value = currentCautiousInput.dataset.previousValidValue;
                }
                modal.style.display = 'none';
                calculateAll();
            });
            
            // 重置按钮事件
            resetBtn.addEventListener('click', function() {
                resetBtn.innerHTML = '<i class="fa fa-refresh fa-spin mr-2"></i>恢复中...';
                setTimeout(() => {
                    for (const [id, value] of Object.entries(initialValues)) {
                        const input = document.getElementById(id);
                        if (input) {
                            input.value = value;
                            input.dataset.previousValidValue = value;
                        }
                    }
                    
                    // 清除汇率缓存，并重置上次更新时间
                    localStorage.removeItem(CACHE_KEY);
                    lastApiUpdateTime = 0; 

                    rubStatus.textContent = '已重置';
                    rubStatus.className = 'text-xs px-2 py-1 rounded bg-blue-100 text-blue-700';
                    usdStatus.textContent = '已重置';
                    usdStatus.className = 'text-xs px-2 py-1 rounded bg-blue-100 text-blue-700';

                    calculateAll();
                    resetBtn.innerHTML = '<i class="fa fa-refresh mr-2"></i>恢复初始数值';
                    showNotification('所有参数已恢复为初始值');
                    updateRefreshButtonState(); // 更新按钮状态
                }, 300);
            });
            
            // 显示通知提示
            function showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification fixed top-5 left-1/2 transform -translate-x-1/2 ${
                    type === 'success' ? 'bg-accent' : (type === 'warning' ? 'bg-orange-500' : 'bg-warning')
                } text-white px-5 py-2 rounded-lg shadow-lg z-50 flex items-center`;
                notification.innerHTML = `<i class="fa ${
                    type === 'success' ? 'fa-check-circle' : (type === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle')
                } mr-2"></i>${message}`;
                document.body.appendChild(notification);
                
                notification.animate([
                    { opacity: 0, transform: 'translate(-50%, -20px)' },
                    { opacity: 1, transform: 'translate(-50%, 0)' },
                    { opacity: 1, transform: 'translate(-50%, 0)' },
                    { opacity: 0, transform: 'translate(-50%, -20px)' }
                ], {
                    duration: 3000,
                    easing: 'ease-in-out'
                });
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
            
            // 获取输入值并校验
            function getInputValue(id, defaultValue = 0) {
                const input = document.getElementById(id);
                if (!input) return defaultValue;
                
                const value = parseFloat(input.value);
                if (isNaN(value)) {
                    return defaultValue;
                }
                return value;
            }
            
            // 计算所有结果
            function calculateAll() {
                try {
                    const C2 = getInputValue('C2', 600);
                    const C3 = getInputValue('C3', 5.75);
                    const C4 = getInputValue('C4', 0.2);
                    const C5 = getInputValue('C5', 330);
                    const C7 = getInputValue('C7', 7) / 100;
                    const C8 = getInputValue('C8', 10) / 100;
                    const C9 = getInputValue('C9', 6) / 100;
                    const C11 = getInputValue('C11', 11.7); // 卢布汇率 (1 CNY = ? RUB)
                    const C12 = getInputValue('C12', 7.2);  // 美元汇率 (1 USD = ? CNY)
                    const C14 = getInputValue('C14', 2.5);
                    const F2 = getInputValue('F2', 1.5);
                    const F3 = getInputValue('F3', 0.1);
                    const F4 = getInputValue('F4', 0.5);
                    const F5 = getInputValue('F5', 6);
                    const F6 = getInputValue('F6', 4);
                    const F7 = getInputValue('F7', 150);
                    const F9 = getInputValue('F9', 1.92);
                    const F10 = getInputValue('F10', 3.5);
                    const D14 = getInputValue('D14', 15);
                    const E14 = getInputValue('E14', 12.00);
                    const F14 = getInputValue('F14', 12.00);
                    const G14 = getInputValue('G14', 28.00);
                    
                    const volume = E14 * F14 * G14;
                    const H14 = Math.floor((60 * 40 * 40) / (volume > 0 ? volume : 1));
                    
                    const safeH14 = H14 > 0 ? H14 : 1;

                    const H8 = (C4 + (F2 / safeH14)) * C14 * C12 + F3 + F4 + ((F5 + F6) / safeH14) + F7 / D14 / safeH14;
                    const H9 = ((F9 + F10) * C12) / safeH14;
                    const H10 = C3 + H8 + H9;
                    
                    const safeC11 = C11 > 0 ? C11 : 1;
                    const H4 = (C5 * (1 - C7) * (1 - C8) * (1 - C9)) / safeC11;
                    
                    const divisorH5 = C2 / safeC11;
                    const H5 = (divisorH5 !== 0) ? ((H4 - H10) / divisorH5) * 100 : 0;
                    
                    // 更新结果显示
                    document.getElementById('H4_value').textContent = H4.toFixed(2);
                    document.getElementById('H5_value').textContent = H5.toFixed(2);
                    document.getElementById('H8_value').textContent = H8.toFixed(2);
                    document.getElementById('H9_value').textContent = H9.toFixed(2);
                    document.getElementById('H10_value').textContent = H10.toFixed(2);
                    document.getElementById('H14_value').textContent = H14;

                    // 根据FBO利润率更新状态显示
                    updateProfitStatus(H5);
                    
                    // 显示计算成功提示
                    showCalculationSuccess();
                } catch (error) {
                    console.error('计算过程中发生错误:', error);
                    showCalculationError();
                }
            }

            // 更新利润率状态显示
            function updateProfitStatus(profitRate) {
                profitStatusElement.textContent = '';
                profitStatusElement.className = 'text-center text-3xl font-extrabold mt-4';

                if (profitRate > 25) {
                    profitStatusElement.textContent = '超赞';
                    profitStatusElement.classList.add('text-green-600');
                } else if (profitRate >= 20 && profitRate <= 25) {
                    profitStatusElement.textContent = '一般';
                    profitStatusElement.classList.add('text-yellow-600');
                } else {
                    profitStatusElement.textContent = '放弃';
                    profitStatusElement.classList.add('text-red-600');
                }
            }
            
            // 显示计算成功提示
            function showCalculationSuccess() {
                const resultElements = document.querySelectorAll('.result-value');
                resultElements.forEach(el => {
                    el.classList.add('bg-green-100');
                    setTimeout(() => {
                        el.classList.remove('bg-green-100');
                    }, 500);
                });
            }
            
            // 显示计算错误提示
            function showCalculationError() {
                const resultElements = document.querySelectorAll('.result-value');
                resultElements.forEach(el => {
                    el.classList.add('bg-red-100');
                    setTimeout(() => {
                        el.classList.remove('bg-red-100');
                    }, 1000);
                });
            }

            // 初始加载时，尝试从缓存加载汇率或从 API 获取
            loadExchangeRates();

            // 为“更新汇率”按钮添加事件监听器
            refreshExchangeBtn.addEventListener('click', async () => {
                const now = Date.now();
                // 检查是否在8小时冷却期内
                if (now - lastApiUpdateTime < CACHE_DURATION) {
                    showNotification('汇率已在8小时内更新过，请稍后再试。', 'warning');
                    updateRefreshButtonState(); // 确保按钮状态正确显示剩余时间
                    return;
                }
                await fetchExchangeRatesFromApi(); // 执行 API 获取
            });
        });
    </script>


</body></html>